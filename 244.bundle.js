(()=>{function e(e,a,t,o,n,s){var r={room:e.room,skybox:e.skybox,name:JSON.stringify(e.name),artifact:s,contract:a,collection:e.collection,id:t,curator:o,gallery:[],thumbnail:n,type:"remote"};if(e.startPoint){for(const a in e.startPoint)if("direction"!=a&&"position"!=a)delete e.startPoint[a];else for(const t in e.startPoint[a])"x"!=t&&"y"!=t&&"z"!=t&&delete e.startPoint[a][t];r.startPoint=e.startPoint}e.hasOwnProperty("gallery")&&(e.gallery.forEach((e=>{for(const a in e)switch(a){case"position":case"rotation":case"scale":for(const t in e[a])"x"===t||"y"===t||"z"===t||delete e[a][t];break;case"objktMetaData":case"tezosMetaData":case"ethereumMetaData":case"openSeaMetaData":case"solanaMetaData":case"fxMetaData":case"tokenType":case"block":case"sculpture":case"IIIFdata":case"datavis":case"note":break;default:delete e[a]}})),e.gallery.forEach((e=>{var a=!1;if(e.hasOwnProperty("objktMetaData")){var t=!1;for(const a in e.objktMetaData)"contract"===a||"token_id"===a?t=!0:delete e.objktMetaData[a];t&&(a=!0)}else"block"!==e.tokenType&&"sculpture"!==e.tokenType&&"datavis"!==e.tokenType&&"openSea"!==e.tokenType&&"tezos"!==e.tokenType&&"ethereum"!==e.tokenType&&"solana"!==e.tokenType&&"IIIF"!==e.tokenType||(a=!0);a&&r.gallery.push(e)}))),e.hasOwnProperty("audioguide")&&(r.audioguide={mainTrack:e.audioguide.mainTrack}),r.gallery.length>0&&postMessage(r)}const a=new FileReader;a.onload=function(e){const a=JSON.parse(e.target.result);switch(!0){case a.hasOwnProperty("room"):o(a);break;case a.hasOwnProperty("id"):"https://gallica.bnf.fr/gallicarama"===a.id&&t(a)}};const t=e=>{const a=[];e.items.forEach((e=>{let t="";e.hasOwnProperty("annotations")&&(e.annotations[0].items[0].metadata.forEach((e=>{"title"===e.label.none[0]&&(t+=e.value.none[0]+"\n")})),t+=e.annotations[0].items[0].body.value),a.push({url:e.items[0].items[0].body.id,note:t})}));const t=e.thumbnail[0].id.replace("full/,120/0","full/,200/0"),o={};e.metadata.forEach((e=>{o[e.label.none[0]]=e.value.none[0]})),postMessage({slides:a,display_uri:t,meta:o,type:"gallicarama"})};onmessage=function(t){switch(t.data.type){case"remote":(a=>{a.data.galleryURLs.forEach((a=>{fetch(a.galurl).then((e=>e.json())).then((t=>{404===t.status?fetch(a.galurl+"/gallery.json").then((e=>e.json())).then((t=>e(t,a.contract,a.id,a.curator,a.thumbnail,a.artifact))):e(t,a.contract,a.id,a.curator,a.thumbnail,a.artifact)}))}))})(t);break;case"IIIF":case"local":(e=>{a.readAsText(e.data.path)})(t)}};const o=e=>{const a=new Date,t={collection:e.collection,gallery:[],name:e.name,room:e.room,skybox:e.skybox,type:"local",timeId:a};if(e.startPoint){for(const a in e.startPoint)if("direction"!=a&&"position"!=a)delete e.startPoint[a];else for(const t in e.startPoint[a])"x"!=t&&"y"!=t&&"z"!=t&&delete e.startPoint[a][t];t.startPoint=e.startPoint}e.hasOwnProperty("gallery")&&(e.gallery.forEach((e=>{for(const a in e)switch(a){case"position":case"rotation":case"scale":for(const t in e[a])"x"===t||"y"===t||"z"===t||delete e[a][t];break;case"objktMetaData":case"tezosMetaData":case"ethereumMetaData":case"openSeaMetaData":case"solanaMetaData":case"fxMetaData":case"tokenType":case"block":case"sculpture":case"IIIFdata":case"datavis":case"note":break;default:delete e[a]}})),e.gallery.forEach((e=>{var a=!1;if(e.hasOwnProperty("objktMetaData")){var o=!1;for(const a in e.objktMetaData)"contract"===a||"token_id"===a?o=!0:delete e.objktMetaData[a];o&&(a=!0)}else"block"!==e.tokenType&&"sculpture"!==e.tokenType&&"datavis"!==e.tokenType&&"openSea"!==e.tokenType&&"tezos"!==e.tokenType&&"ethereum"!==e.tokenType&&"solana"!==e.tokenType&&"IIIF"!==e.tokenType||(a=!0);a&&t.gallery.push(e)}))),e.hasOwnProperty("audioguide")&&(t.audioguide={mainTrack:e.audioguide.mainTrack}),t.gallery.length>0&&postMessage(t)}})();