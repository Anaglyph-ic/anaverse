(()=>{function e(e,t,a,o,n,s,r){var c={room:e.room,skybox:e.skybox,name:JSON.stringify(e.name),artifact:s,contract:t,collection:e.collection,id:a,curator:o,gallery:[],thumbnail:n,type:"remote"};if(e.startPoint){for(const t in e.startPoint)if("direction"!=t&&"position"!=t)delete e.startPoint[t];else for(const a in e.startPoint[t])"x"!=a&&"y"!=a&&"z"!=a&&delete e.startPoint[t][a];c.startPoint=e.startPoint}e.hasOwnProperty("gallery")&&(e.gallery.forEach((e=>{for(const t in e)switch(t){case"position":case"rotation":case"scale":for(const a in e[t])"x"===a||"y"===a||"z"===a||delete e[t][a];break;case"objktMetaData":case"tezosMetaData":case"ethereumMetaData":case"openSeaMetaData":case"solanaMetaData":case"fxMetaData":case"tokenType":case"block":case"sculpture":case"IIIFdata":case"datavis":case"note":break;default:delete e[t]}})),e.gallery.forEach((e=>{var t=!1;if(e.hasOwnProperty("objktMetaData")){var a=!1;for(const t in e.objktMetaData)"contract"===t||"token_id"===t?a=!0:delete e.objktMetaData[t];a&&(t=!0)}else"block"!==e.tokenType&&"sculpture"!==e.tokenType&&"datavis"!==e.tokenType&&"openSea"!==e.tokenType&&"tezos"!==e.tokenType&&"ethereum"!==e.tokenType&&"solana"!==e.tokenType&&"IIIF"!==e.tokenType||(t=!0);t&&c.gallery.push(e)}))),e.hasOwnProperty("audioguide")&&(c.audioguide={mainTrack:e.audioguide.mainTrack}),c.item=r,c.gallery.length>0&&("string"==typeof e.room||postMessage(c))}const t=new FileReader;t.onload=function(e){const t=JSON.parse(e.target.result);switch(!0){case t.hasOwnProperty("room"):o(t);break;case t.hasOwnProperty("id"):"https://gallica.bnf.fr/gallicarama"===t.id&&a(t)}};const a=e=>{const t=[];e.items.forEach((e=>{let a="";e.hasOwnProperty("annotations")&&(e.annotations[0].items[0].metadata.forEach((e=>{"title"===e.label.none[0]&&(a+=e.value.none[0]+"\n")})),a+=e.annotations[0].items[0].body.value),t.push({url:e.items[0].items[0].body.id,note:a})}));const a=e.thumbnail[0].id.replace("full/,120/0","full/,200/0"),o={};e.metadata.forEach((e=>{o[e.label.none[0]]=e.value.none[0]})),postMessage({slides:t,display_uri:a,meta:o,type:"gallicarama"})};onmessage=function(a){switch(a.data.type){case"remote":(t=>{var a=t.data.galleryURLs;for(let t=0;t<a.length;t++){const o=a[t];setTimeout((()=>{fetch(o.galurl).then((e=>e.json())).then((t=>{404===t.status?fetch(o.galurl+"/gallery.json").then((e=>e.json())).then((t=>e(t,o.contract,o.id,o.curator,o.thumbnail,o.artifact,o.item))):e(t,o.contract,o.id,o.curator,o.thumbnail,o.artifact,o.item)}))}),20*t)}})(a);break;case"IIIF":case"local":(e=>{t.readAsText(e.data.path)})(a)}};const o=e=>{const t=new Date,a={collection:e.collection,gallery:[],name:e.name,room:e.room,skybox:e.skybox,type:"local",timeId:t};if(e.startPoint){for(const t in e.startPoint)if("direction"!=t&&"position"!=t)delete e.startPoint[t];else for(const a in e.startPoint[t])"x"!=a&&"y"!=a&&"z"!=a&&delete e.startPoint[t][a];a.startPoint=e.startPoint}e.hasOwnProperty("gallery")&&(e.gallery.forEach((e=>{for(const t in e)switch(t){case"position":case"rotation":case"scale":for(const a in e[t])"x"===a||"y"===a||"z"===a||delete e[t][a];break;case"objktMetaData":case"tezosMetaData":case"ethereumMetaData":case"openSeaMetaData":case"solanaMetaData":case"fxMetaData":case"tokenType":case"block":case"sculpture":case"IIIFdata":case"datavis":case"note":break;default:delete e[t]}})),e.gallery.forEach((e=>{var t=!1;if(e.hasOwnProperty("objktMetaData")){var o=!1;for(const t in e.objktMetaData)"contract"===t||"token_id"===t?o=!0:delete e.objktMetaData[t];o&&(t=!0)}else"block"!==e.tokenType&&"sculpture"!==e.tokenType&&"datavis"!==e.tokenType&&"openSea"!==e.tokenType&&"tezos"!==e.tokenType&&"ethereum"!==e.tokenType&&"solana"!==e.tokenType&&"IIIF"!==e.tokenType||(t=!0);t&&a.gallery.push(e)}))),e.hasOwnProperty("audioguide")&&(a.audioguide={mainTrack:e.audioguide.mainTrack}),a.gallery.length>0&&postMessage(a)}})();