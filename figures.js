const genererFigures=(t,e)=>{let s="123456789abcdefghijkmnopqrstuvwxyzABCDEFGHJKLMNPQRSTUVWXYZ",r=t.slice(2),n=new RegExp(".{"+(t.length/4|0)+"}","g");var o=((t,e,s,r)=>()=>{var n=((t|=0)+(e|=0)|0)+(r|=0)|0;return r=r+1|0,t=e^e>>>9,e=(s|=0)+(s<<3)|0,s=(s=s<<21|s>>>11)+n|0,(n>>>0)/4294967296})(...r.match(n).map((t=>{return e=t,[...e].reduce(((t,e)=>t*s.length+s.indexOf(e)|0),0);var e})));const i=[],l=100;class u{constructor(t,e,s,r,n,o,i={}){this.x=t,this.y=e,this.z=s,this.ex=r,this.ey=n,this.ez=o,this.flag=0,this.data=i,this.visible=!0}}const x=new Int8Array(129);function c(t,e){return 1<<t|1<<(1&t|6&e)|1<<(2&t|5&e)|1<<(3&t|4&e)|1<<(4&t|3&e)|1<<(5&t|2&e)|1<<(6&t|1&e)|1<<e}x[2]=1,x[4]=2,x[8]=3,x[16]=4,x[32]=5,x[64]=6,x[128]=7;const h=new Uint8Array(64);for(let t=0;t<64;t++){const e=t>>3,s=7&t;h[t]=c(e,s)}function y(t,e){let s=0,r=0;return e.z-e.ez>=t.z?(s=4,r=4):e.z+e.ez>=t.z&&(r=4),e.y-e.ey>=t.y?(s|=2,r|=2):e.y+e.ey>=t.y&&(r|=2),e.x-e.ex>=t.x?(s|=1,r|=1):e.x+e.ex>=t.x&&(r|=1),h[8*s+r]}function a(t,e,s){const r=new g(t);return r.ex=.5*e.ex,r.ey=.5*e.ey,r.ez=.5*e.ez,r.x=e.x-r.ex+e.ex*(1&s),r.y=e.y-r.ey+e.ey*((2&s)>>1),r.z=e.z-r.ez+e.ez*((4&s)>>2),r.depth=e.depth+1,r.parent=e,e.subnodes[s]=r,e.nodesCount++,e.nodesMask|=1<<s,r}function z(t,e,s){if(e.count++,e.type===g.LEAF)e.items.push(s),e.count>=t.treshold&&d(t,e);else{const r=y(e,s),n=e.nodesMask;for(let o=0;o<8;o++)r&1<<o&&z(t,n&1<<o?e.subnodes[o]:a(t,e,o),s)}}function f(t,e,s){if(e.type===g.LEAF){const t=e.items.indexOf(s);return-1!==t&&(e.items.splice(t,1),e.count--,!0)}{let r,n=!0,o=y(e,s);for(let i=0;i<8;i++)o&1<<i&&(r=e.subnodes[i],f(t,r,s)?0===r.count&&(e.subnodes[i]=null,e.nodesCount--,e.nodesMask^=1<<i):n=!1);return!0===n&&e.count--,e.count<e.tree.treshold&&p(e),n}}function d(t,e){if(e.depth>t.maxDepth)return;if(e.ex<=e.tree.tearDrop)return;let s,r,n,o=e.items,i=o.length;e.type=g.BRANCH,e.items=null;for(let l=0;l<i;l++){s=o[l],r=y(e,s),n=e.nodesMask;for(let o=0;o<8;o++)r&1<<o&&z(t,n&1<<o?e.subnodes[o]:a(t,e,o),s)}}function p(t){let e,s,r,n,o,i,l=t.nodesMask;t.type=g.LEAF,t.nodesCount=0,t.nodesMask=0;for(let u=0;u<8;u++)if(l&1<<u){if(e=u,s=t.subnodes[e],null===t.items)t.items=s.items;else{r=t.items,n=s.items,o=n.length;for(let t=0;t<o;t++)-1===r.indexOf(i=n[t])&&r.push(i)}t.subnodes[e]=null}}function m(t,e,s){if(t.type===g.BRANCH){const r=y(t,e);for(let n=0;n<8;n++)if(r&1<<n){const r=t.subnodes[n];null!==r&&m(r,e,s)}}else{const r=t.items,n=r.length;for(let t=0;t<n;t++){const n=r[t];n!==e&&(n.flag=1,s.push(n))}}}function b(t,e){if(e.depth=e.parent.depth+1,e.type===g.BRANCH)if(e.depth>t.maxDepth)p(e);else{const s=e.nodesMask;for(let r=0;r<8;r++)s&1<<r&&b(t,e.subnodes[r])}}class g{constructor(t){this.tree=t,this.type=0,this.items=[],this.count=0,this.nodesCount=0,this.nodesMask=0,this.parent=null,this.depth=0,this.x=0,this.y=0,this.z=0,this.ex=0,this.ey=0,this.ez=0,this.subnodes=[null,null,null,null,null,null,null,null]}static LEAF=0;static BRANCH=1;insert(t){return z(this.tree,this,t)}remove(t){return f(this.tree,this,t)}retrieve(t,e){return m(this,t,e)}grow(t){return function(t,e,s){if(null!==e.parent)return!1;const r=2*e.ex,n=2*e.ey,o=2*e.ez,i=e.x+e.ex-r*(1&s),l=e.y+e.ey-n*((2&s)>>1),u=e.z+e.ez-o*((4&s)>>2);if(e.type===g.BRANCH){const x=new g(t);return x.x=i,x.y=l,x.z=u,x.ex=r,x.ey=n,x.ez=o,d(t,x),x.subnodes[s]=e,x.count=e.count,x.nodesCount=1,x.nodesMask=1<<s,e.parent=x,b(t,e),x}return e.x=i,e.y=l,e.z=u,e.ex=r,e.ey=n,e.ez=o,e}(this.tree,this,t)}shrink(){return function(t,e){if(null===e.parent&&1===e.nodesCount){const s=e.subnodes[x[e.nodesMask]];return s.parent.depth=-1,b(t,s),s.parent=null,s}return!1}(this.tree,this)}}class R{constructor(t,e,s){this.maxDepth=t||8,this.treshold=e||32,this.tearDrop=s||.1,this.root=null}static Item=u;static Node=g;insert(t){let e=this.root;if(null===e&&(e=this.root=new g(this),e.x=t.x,e.y=t.y,e.z=t.z,e.ex=t.ex,e.ey=t.ey,e.ez=t.ez),t.x-t.ex>=e.x-e.ex&&t.x+t.ex<=e.x+e.ex&&t.y-t.ey>=e.y-e.ey&&t.y+t.ey<=e.y+e.ey&&t.z-t.ez>=e.z-e.ez&&t.z+t.ez<=e.z+e.ez)e.insert(t);else{const s=e.x-t.x,r=e.y-t.y,n=e.z-t.z;this.grow(s,r,n),this.insert(t)}}remove(t){const e=this.root;if(t.x-t.ex>=e.x-e.ex&&t.x+t.ex<=e.x+e.ex&&t.y-t.ey>=e.y-e.ey&&t.y+t.ey<=e.y+e.ey&&t.z-t.ez>=e.z-e.ez&&t.z+t.ez<=e.z+e.ez){const s=e.remove(t);return!0===s&&this.shrink(),0===e.count&&(this.root=null),s}return!1}retrieve(t,e=[]){if(null!==this.root){this.root.retrieve(t,e);const s=e.length;let r=0;for(let t=0;t<s;t++){const s=e[t];!0===s.visible&&1===s.flag&&(s.flag=0,e[r++]=s)}e.splice(r,s-r)}return e}grow(t,e,s){const r=((s=s>=0?1:0)<<2)+((e=e>=0?1:0)<<1)+(t=t>=0?1:0);this.root=this.root.grow(r)}shrink(){const t=this.root.shrink();!1!==t&&(this.root=t)}}let w={},M=null;const v={},k=[],A=[],C=new R(8,8,.1),F={x(t,e){t[12]+=t[0]*e,t[13]+=t[1]*e,t[14]+=t[2]*e,t[15]+=t[3]*e},y(t,e){t[12]+=t[4]*e,t[13]+=t[5]*e,t[14]+=t[6]*e,t[15]+=t[7]*e},z(t,e){t[12]+=t[8]*e,t[13]+=t[9]*e,t[14]+=t[10]*e,t[15]+=t[11]*e},s(t,e){const s=Array.isArray(e),r=s?e[0]:e,n=s?e[1]:r,o=s?e[2]:r;t[0]*=r,t[1]*=r,t[2]*=r,t[3]*=r,t[4]*=n,t[5]*=n,t[6]*=n,t[7]*=n,t[8]*=o,t[9]*=o,t[10]*=o,t[11]*=o},rx(t,e){const s=Math.PI*(e/180),r=Math.sin(s),n=Math.cos(s),o=t[4],i=t[5],l=t[6],u=t[7],x=t[8],c=t[9],h=t[10],y=t[11];t[4]=o*n+x*r,t[5]=i*n+c*r,t[6]=l*n+h*r,t[7]=u*n+y*r,t[8]=o*-r+x*n,t[9]=i*-r+c*n,t[10]=l*-r+h*n,t[11]=u*-r+y*n},ry(t,e){const s=Math.PI*(e/180),r=Math.sin(s),n=Math.cos(s),o=t[0],i=t[1],l=t[2],u=t[3],x=t[8],c=t[9],h=t[10],y=t[11];t[0]=o*n+x*-r,t[1]=i*n+c*-r,t[2]=l*n+h*-r,t[3]=u*n+y*-r,t[8]=o*r+x*n,t[9]=i*r+c*n,t[10]=l*r+h*n,t[11]=u*r+y*n},rz(t,e){const s=Math.PI*(e/180),r=Math.sin(s),n=Math.cos(s),o=t[0],i=t[1],l=t[2],u=t[3],x=t[4],c=t[5],h=t[6],y=t[7];t[0]=o*n+x*r,t[1]=i*n+c*r,t[2]=l*n+h*r,t[3]=u*n+y*r,t[4]=o*-r+x*n,t[5]=i*-r+c*n,t[6]=l*-r+h*n,t[7]=u*-r+y*n},l(t,e){t[16]=e},b(t,e){t[16]+=e>0?e*(1-t[16]):e*t[16]},md(t,e){t[21]=e},ao(t,e){t[22]=e},identity(t,e){t[0]=e,t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=e,t[6]=0,t[7]=0,t[8]=0,t[9]=0,t[10]=e,t[11]=0}},B=(t,e)=>{const s=[0,2,4,6,6,1],r=t.data.v,n=e.data.v,o=e.data.n;for(let t=0;t<8;t++){const e=r[3*t+0],i=r[3*t+1],l=r[3*t+2];for(let t=0;t<6;t++){const r=o[3*t+0],u=o[3*t+1],x=o[3*t+2],c=3*s[t];if(e*r+i*u+l*x-(r*n[c+0]+u*n[c+1]+x*n[c+2])>=0)return!1}}return!0},D=new Float64Array([-.5,-.5,-.5,-.5,.5,-.5,.5,-.5,-.5,.5,.5,-.5,.5,-.5,.5,.5,.5,.5,-.5,-.5,.5,-.5,.5,.5]),I=new Float64Array([-.1,-.1,-.5,-.1,.1,-.5,.1,-.1,-.5,.1,.1,-.5,.5,-.5,.5,.5,.5,.5,-.5,-.5,.5,-.5,.5,.5]),N=(t,s,r)=>{const n=[9999,9999,9999],o=[-9999,-9999,-9999],u=[];for(let e=0;e<8;e++){const r=3*e,i=s[r+0],l=s[r+1],x=s[r+2],c=i*t[0]+l*t[4]+x*t[8]+t[12],h=i*t[1]+l*t[5]+x*t[9]+t[13],y=i*t[2]+l*t[6]+x*t[10]+t[14];u.push(c,h,y),c<n[0]?n[0]=c:c>o[0]&&(o[0]=c),h<n[1]?n[1]=h:h>o[1]&&(o[1]=h),y<n[2]?n[2]=y:y>o[2]&&(o[2]=y)}const x=.5*(n[0]+o[0]),c=.5*(n[1]+o[1]),h=.5*(n[2]+o[2]),y=.5*(o[0]-n[0]),a=.5*(o[1]-n[1]),z=.5*(o[2]-n[2]);if(e)switch(r){case"tube":case"cube":i.push({geometry:{type:"BoxGeometry",args:[y*l*2,a*l*2,z*l*2]},pos:{x:x*l,y:50+c*l,z:h*l-500},rot:{x:0,y:0,z:0},lines:!0,hatch:!0,full:!1});break;case"pyramid":i.push({geometry:{type:"CylinderGeometry",args:[y*l*.5,z*l*1.415,a*l,4,1]},pos:{x:x*l,y:50+c*l-a*l*.5,z:h*l-500},rot:{x:0,y:Math.PI/4,z:0},lines:!0,hatch:!0,full:!1})}else{const e=[u[9]-u[15],u[10]-u[16],u[11]-u[17],u[9]-u[3],u[10]-u[4],u[11]-u[5],0,0,0,0,0,0,u[18]-u[21],u[19]-u[22],u[20]-u[23],0,0,0];e[6]=-e[0],e[7]=-e[1],e[8]=-e[2],e[9]=-e[3],e[10]=-e[4],e[11]=-e[5],e[15]=-e[12],e[16]=-e[13],e[17]=-e[14];const s={v:u,n:e,b:t[16],t:t[20],ao:t[22]},r=new R.Item(x,c,h,y,a,z,s);C.insert(r)}},E=(t,e)=>{const s=t.slice(0);s[20]=0;for(const t in e)F[t](s,e[t]);N(s,D,"cube")},H=(t,e)=>{const s=t.slice(0);s[20]=1;for(const t in e)F[t](s,e[t]);N(s,D,"tube")},L=(t,e)=>{const s=t.slice(0);s[18]++;for(const t in e)F[t](s,e[t]);return s},P=t=>(e,s)=>{const r=L(e,s);r[19]=t,A.push(r)},G=(t,e,s,r)=>(n,o)=>{const i=L(n,o);let l=0;const u=M()*t;for(let t=0;t<r;t++)if(l+=e[t],u<=l)return i[19]=s[t],void A.push(i)},O={start:"start",transform:{s:4},maxDepth:10},q={start(t){E(t,{x:-.5,z:-.5,y:-.15,l:.75,s:[.95,.1,.95]}),E(t,{x:-.5,z:.5,y:-.15,l:.75,s:[.95,.1,.95]}),E(t,{x:.5,z:-.5,y:-.15,l:.75,s:[.95,.1,.95]}),E(t,{x:.5,z:.5,y:-.15,l:.75,s:[.95,.1,.95]}),v.tower(t,{x:-.55,z:-.55,y:0,l:.75,rx:90,s:[1.05,.85,.5]}),v.tower(t,{x:-.55,z:.55,y:0,l:.75,rx:90,s:[1.05,.85,.5]}),v.tower(t,{x:.55,z:-.55,y:0,l:.75,rx:90,s:[1.05,.85,.5]}),v.tower(t,{x:.55,z:.55,y:0,l:.75,rx:90,s:[1.05,.85,.5]}),o()>.5?(v.R1(t,{s:1,rx:90}),v.R1(t,{x:.65,z:.65,s:.75,rx:90,md:8}),v.R1(t,{x:-.65,z:.65,s:.75,rx:90,md:8}),v.R1(t,{x:.65,z:-.65,s:.75,rx:90,md:8}),v.R1(t,{x:-.65,z:-.65,s:.75,rx:90,md:8})):o()>.5?(v.R1(t,{x:.5,z:.5,s:.75,rx:90,md:10}),v.R1(t,{x:-.5,z:.5,s:.75,rx:90,md:10}),v.R1(t,{x:.5,z:-.5,s:.75,rx:90,md:10}),v.R1(t,{x:-.5,z:-.5,s:.75,rx:90,md:10})):(v.R1(t,{s:1,rx:90,md:11}),v.R1(t,{x:.75,s:.5,rx:90,md:9}),v.R1(t,{x:-.75,s:.5,rx:90,md:9}),v.R1(t,{z:.75,s:.5,rx:90,md:9}),v.R1(t,{z:-.75,s:.5,rx:90,md:9}))},R1:[1,t=>{v.block(t,{s:1+.1*o()});const e=.35,s=.35;t[18]<6&&t[13]<.75&&(E(t,{x:1,z:.18,s:[3,.3+.01*o(),.0152+.01*o()]}),v.road(t,{x:1,z:.1,s:[3,.3,.2]})),v.R1(t,{x:-e,y:s,s:.5,rz:90}),v.R1(t,{x:e,y:-s,s:.5}),v.R1(t,{x:-e,y:-s,s:.5,rz:90}),v.R1(t,{x:e,y:s,s:.5})},o()+1,t=>{v.block(t,{s:1+.1*o()}),v.R1(t,{z:-.1,s:[.75,.75,1.5],rz:90}),v.R1(t,{z:.1,s:[1,1,.75],rz:90})}],block(t){o()>.5?v.tube(t,{s:[.5,.5,.2]}):v.cube(t,{s:[.5,.5,.2]})},tube(t){H(t,{x:-.45,rx:90,s:[.1,.8,1]}),H(t,{x:.45,rx:90,s:[.1,.8,1]}),E(t,{z:.45,s:[1,1,.1]}),o()>.5?((t,e)=>{const s=t.slice(0);s[20]=2;for(const t in e)F[t](s,e[t]);N(s,I,"pyramid")})(t,{z:-.475,rz:-90,s:[1,1,.15]}):E(t,{z:-.45,s:[1,1,.1]})},cube(t){H(t,{x:-.35,y:-.35,rx:90,s:[.4,.9,.4]}),H(t,{x:-.35,y:.35,rx:90,s:[.4,.9,.4]}),H(t,{x:.35,y:-.35,rx:90,s:[.4,.9,.4]}),H(t,{x:.35,y:.35,rx:90,s:[.4,.9,.4]}),t[13]>.25&&(t=>{const e=t[0]*t[0]+t[1]*t[1]+t[2]*t[2],s=t[4]*t[4]+t[5]*t[5]+t[6]*t[6],r=t[8]*t[8]+t[9]*t[9]+t[10]*t[10];return Math.sqrt(e*e+s*s+r*r)})(t)>2&&(t[18]=0,v.tower(t,{z:-.4,s:[1.3,1.3,.1],rz:-90,rx:180})),E(t,{z:-.45,s:[1.2,1.2,.1]}),E(t,{z:.45,s:[1.2,1.2,.1]})},road(t){if(!e)for(let e=0;e<100;e++)E(t,{x:.5*(o()-o()),y:.5*(o()-o()),z:.5*(o()-o()),s:[.02,.1,.01],l:.5+.3*o(),ao:0})},tower(t){E(t,{z:.4,s:[.6,1.2,.3]}),v.tower(t,{s:[.8,.9,1.4],rz:90})}};e&&i.push({geometry:{type:"BoxGeometry",args:[10,2,120]},pos:{x:0,y:-2,z:-50},rot:{x:0,y:0,z:0},lines:!0,hatch:!0,full:!1}),((t,e,s)=>{M=s,w=t,k.length=0;for(const t in e){const s=e[t];if(Array.isArray(s)){let e=0;const r=[],n=[];for(let t=0;t<s.length;t+=2)e+=s[t],k.push(s[t+1]),r.push(s[t]),n.push(k.length-1);v[t]=G(e,r,n,n.length)}else k.push(s),v[t]=P(k.length-1)}})(O,q,o);const U=((t,e)=>{A.length=0,C.root=null,v[t]([1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1,1,0,0,0,0,w.maxDepth||100,1],e);do{const t=A.pop();t[18]<=t[21]&&k[t[19]](t)}while(A.length>0);const s=C.retrieve(new R.Item(0,0,0,1e3,1e3,1e3));for(const t of s)if(!0===t.visible){const e=C.retrieve(t);for(const s of e)if(!0===s.visible){if(0==(r=s,n=t,!(Math.abs(r.x-n.x)>r.ex+n.ex||Math.abs(r.y-n.y)>r.ey+n.ey||Math.abs(r.z-n.z)>r.ez+n.ez)))continue;!0===B(s,t)&&(s.visible=!1)}}var r,n;return C.root=null,s.filter((t=>!0===t.visible))})(O.start,O.transform);var j={figures:i,features:{}};return e||(j.cubes=U),j};export{genererFigures};